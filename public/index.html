<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro / Edi√ß√£o</title>
  <link rel="manifest" href="/manifest.json">

  <style>
    body{font-family:system-ui;background:#0b0b0b;color:#fff;margin:0}
    header{padding:18px;font-size:26px;font-weight:900;text-align:center}
    .wrap{padding:16px;display:grid;gap:12px;max-width:720px;margin:0 auto}

    button,input{font-size:22px;padding:16px;border-radius:16px;border:0;width:100%}
    button{background:#2f7cff;color:#fff;font-weight:900}
    button.save{background:#22c55e;color:#000}
    button.gray{background:#3a3a3a}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input{background:#fff;color:#000}

    .hint{font-size:18px;opacity:.9;line-height:1.3;text-align:center}
    .card{background:#151515;border-radius:18px;padding:16px}

    .ok{
      display:none;
      background:#22c55e;
      color:#071a0a;
      font-weight:900;
      text-align:center;
      padding:12px;
      border-radius:14px;
    }
    .ok.show{display:block}

    #scanVideo{width:100%;border-radius:18px;background:#000;margin-top:10px}

    .resultItem{
      display:grid;
      gap:10px;
      padding:12px;
      border-radius:14px;
      background:#101010;
      border:1px solid #2a2a2a;
    }

    .resultTitle{font-size:22px;font-weight:900}
    .price{font-size:20px;font-weight:800}
    .price span{background:#ffe45c;color:#111;padding:4px 10px;border-radius:10px}

    img{width:100%;max-height:260px;object-fit:contain;border-radius:14px;background:#000}
    hr{border:0;border-top:1px solid #2a2a2a;margin:10px 0}
    .small{font-size:16px;opacity:.9}
  </style>
</head>

<body>
<header>Cadastro / Edi√ß√£o</header>

<div class="wrap">

  <div class="hint">
    üîé Busque por <b>nome</b> ou <b>GTIN</b>. Selecione um item para editar.
  </div>

  <input id="search" placeholder="Buscar por nome ou GTIN">

  <div class="row">
    <button id="btnBuscar">üîç Buscar</button>
    <button class="gray" id="btnLimpar">üßπ Limpar</button>
  </div>

  <div class="card" id="status">Aguardando‚Ä¶</div>

  <div class="card" id="results" style="display:none;"></div>

  <div class="ok" id="ok">‚úÖ C√ìDIGO LIDO!</div>

  <div class="card" id="editor" style="display:none;">
    <div class="hint" style="margin-bottom:10px;">
      <b>Edi√ß√£o</b> (para mudar GTIN, use ‚ÄúEscanear GTIN‚Äù)
    </div>

    <div class="row">
      <button id="btnScanGtin">üì∑ Escanear GTIN</button>
      <button class="gray" id="btnFecharCam">‚úñ Fechar c√¢mera</button>
    </div>

    <input id="gtin" placeholder="GTIN">
    <input id="nome" placeholder="Nome dos Produtos">
    <input id="preco" placeholder="Domingas R$ (opcional)">
    <input id="imagemUrl" placeholder="URL da imagem (opcional ‚Äî s√≥ se quiser trocar)">

    <button class="save" id="btnSalvar">üíæ Salvar no Notion</button>

    <div id="preview" style="margin-top:12px;"></div>
  </div>

</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let reader=null;
let scanning=false;
let videoEl=null;

let selectedPageId="";     // atualiza o item correto
let lastFoundItems=[];

const statusEl = document.getElementById("status");
const resultsBox = document.getElementById("results");
const editorEl = document.getElementById("editor");
const okEl = document.getElementById("ok");

function setStatus(msg){ statusEl.textContent = msg; }

function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator();
    o.frequency.value=880;
    o.connect(ctx.destination);
    o.start();
    setTimeout(()=>o.stop(),80);
  }catch(e){}
}

function flashGreen(){
  okEl.classList.add("show");
  setTimeout(()=>okEl.classList.remove("show"),800);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])
  );
}

function formatPrice(v){
  if(v === null || v === undefined || v === "") return "‚Äî";
  if(typeof v === "number"){
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }
  return String(v).includes("R$") ? v : ("R$ " + v);
}

function stopScan(){
  try{ reader?.reset?.(); }catch(e){}
  if(videoEl){
    try{ videoEl.srcObject && videoEl.srcObject.getTracks().forEach(t=>t.stop()); }catch(e){}
    try{ videoEl.remove(); }catch(e){}
  }
  videoEl=null;
  scanning=false;
}

function showEditor(show){
  editorEl.style.display = show ? "block" : "none";
}

function renderPreview(item){
  const div = document.getElementById("preview");
  if(!item){ div.innerHTML=""; return; }
  div.innerHTML = `
    <hr>
    <div class="resultTitle">${escapeHtml(item.name)}</div>
    <div class="price">Pre√ßo: <span>${escapeHtml(formatPrice(item.preco))}</span></div>
    <div class="small">GTIN atual: ${escapeHtml(item.gtin || "‚Äî")}</div>
    ${item.img ? `<img src="${item.img}" alt="Imagem">` : `<div class="small">Sem imagem</div>`}
  `;
}

async function buscar(){
  stopScan();
  const q = document.getElementById("search").value.trim();
  if(!q){ setStatus("Digite um nome ou GTIN para buscar."); return; }

  setStatus("Buscando no Notion‚Ä¶");
  resultsBox.style.display = "none";
  resultsBox.innerHTML = "";

  showEditor(false);
  selectedPageId = "";
  lastFoundItems = [];

  const r = await fetch(`/api/lookup?q=${encodeURIComponent(q)}`);
  const d = await r.json().catch(()=>({}));

  if(!r.ok || !d.found || !d.items?.length){
    setStatus("Nada encontrado.");
    return;
  }

  lastFoundItems = d.items;
  setStatus(`Encontrei ${d.items.length} item(ns). Toque em um para editar.`);

  resultsBox.style.display = "block";
  resultsBox.innerHTML = d.items.map((it, idx) => `
    <div class="resultItem" data-idx="${idx}">
      <div class="resultTitle">${escapeHtml(it.name)}</div>
      <div class="price">Pre√ßo: <span>${escapeHtml(formatPrice(it.preco))}</span></div>
      <div class="small">GTIN: ${escapeHtml(it.gtin || "‚Äî")}</div>
      ${it.img ? `<img src="${it.img}" alt="Imagem">` : ""}
      <div class="small">Toque para editar</div>
    </div>
  `).join("<hr>");

  // ‚úÖ CORRE√á√ÉO: usa addEventListener (funciona em iOS/Android/PWA)
  resultsBox.querySelectorAll(".resultItem").forEach(el => {
    el.addEventListener("click", () => {
      const idx = Number(el.dataset.idx);
      selecionar(idx);
    });
  });
}

function selecionar(i){
  stopScan();
  const it = lastFoundItems[i];
  if(!it) return;

  selectedPageId = it.pageId || "";

  document.getElementById("gtin").value = it.gtin || "";
  document.getElementById("nome").value = it.name || "";
  document.getElementById("preco").value = (it.preco ?? "") === null ? "" : String(it.preco ?? "");
  document.getElementById("imagemUrl").value = ""; // s√≥ se quiser trocar

  showEditor(true);
  setStatus("Editando. Se quiser mudar o GTIN, use ‚ÄúEscanear GTIN‚Äù.");
  renderPreview(it);
}

async function scanToGtin(){
  if(scanning) return;
  stopScan();
  scanning = true;

  setStatus("Aponte para o c√≥digo de barras‚Ä¶");

  videoEl = document.createElement("video");
  videoEl.id = "scanVideo";
  videoEl.setAttribute("playsinline","true");
  document.querySelector(".wrap").insertBefore(videoEl, statusEl);

  const hints = new Map();
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.UPC_A
  ]);

  reader = new ZXing.BrowserMultiFormatReader(hints);

  try{
    reader.decodeFromVideoDevice(null, videoEl, (result)=>{
      if(result){
        const code = result.getText().trim();
        stopScan();
        beep(); flashGreen();
        document.getElementById("gtin").value = code;
        setStatus("GTIN preenchido pelo scanner. Agora √© s√≥ salvar.");
      }
    });
  }catch(e){
    stopScan();
    setStatus("N√£o consegui acessar a c√¢mera. Verifique permiss√µes do navegador.");
  }
}

async function salvar(){
  stopScan();

  const gtin = document.getElementById("gtin").value.trim();
  const nome = document.getElementById("nome").value.trim();
  const preco = document.getElementById("preco").value.trim();
  const imagemUrl = document.getElementById("imagemUrl").value.trim();

  if(!gtin){ setStatus("Informe o GTIN (voc√™ pode escanear)."); return; }
  if(!nome){ setStatus("Informe o Nome dos Produtos."); return; }
  if(!selectedPageId){
    setStatus("Selecione um item na lista para editar.");
    return;
  }

  setStatus("Salvando no Notion‚Ä¶");

  const r = await fetch("/api/upsert", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ pageId: selectedPageId, gtin, nome, preco, imagemUrl })
  });

  const d = await r.json().catch(()=>({}));

  if(!r.ok || !d.ok){
    setStatus("Erro ao salvar. Se quiser, me mande print desta tela.");
    return;
  }

  setStatus("‚úÖ Atualizado no Notion!");
}

function limparTudo(){
  stopScan();
  document.getElementById("search").value = "";
  resultsBox.style.display = "none";
  resultsBox.innerHTML = "";
  selectedPageId = "";
  lastFoundItems = [];
  showEditor(false);
  document.getElementById("preview").innerHTML = "";
  setStatus("Aguardando‚Ä¶");
}

// atalhos de bot√£o
document.getElementById("btnBuscar").addEventListener("click", buscar);
document.getElementById("btnLimpar").addEventListener("click", limparTudo);
document.getElementById("btnScanGtin").addEventListener("click", scanToGtin);
document.getElementById("btnFecharCam").addEventListener("click", stopScan);
document.getElementById("btnSalvar").addEventListener("click", salvar);

// Enter no teclado faz buscar
document.getElementById("search").addEventListener("keydown", (e) => {
  if(e.key === "Enter") buscar();
});
</script>

</body>
</html>