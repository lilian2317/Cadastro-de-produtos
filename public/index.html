<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Produtos</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    body{font-family:system-ui;background:#0b0b0b;color:#fff;margin:0}
    header{padding:18px;font-size:26px;font-weight:900;text-align:center}
    .wrap{padding:16px;display:grid;gap:12px;max-width:720px;margin:0 auto}
    button,input{font-size:22px;padding:16px;border-radius:16px;border:0;width:100%}
    button{background:#2f7cff;color:#fff;font-weight:900}
    button.save{background:#22c55e;color:#000}
    button.gray{background:#3a3a3a}
    input{background:#fff;color:#000}
    .hint{font-size:18px;opacity:.9;line-height:1.3;text-align:center}
    .card{background:#151515;border-radius:18px;padding:16px}
    .ok{display:none;background:#22c55e;color:#071a0a;font-weight:900;text-align:center;padding:12px;border-radius:14px}
    .ok.show{display:block}
    #scanVideo{width:100%;border-radius:18px;background:#000}
  </style>
</head>
<body>
<header>Cadastro de Produtos</header>

<div class="wrap">
  <button onclick="scan()">ðŸ“· Escanear GTIN</button>
  <div class="hint">Se a cÃ¢mera desfocar, <b>afaste o celular</b> atÃ© o cÃ³digo ficar nÃ­tido.</div>

  <div class="ok" id="ok">âœ… CÃ“DIGO LIDO!</div>

  <div class="card" id="status">Aguardandoâ€¦</div>

  <input id="gtin" placeholder="GTIN (vai preencher ao escanear)">
  <input id="nome" placeholder="Nome dos Produtos">
  <input id="preco" placeholder="Domingas R$ (opcional)">

  <button class="save" onclick="salvar()">ðŸ’¾ Salvar no Notion</button>
  <button class="gray" onclick="limpar()">ðŸ§¹ Limpar</button>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let reader=null;
let scanning=false;
let videoEl=null;

function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator();
    o.frequency.value=880;
    o.connect(ctx.destination);
    o.start();
    setTimeout(()=>o.stop(),80);
  }catch(e){}
}
function flashGreen(){
  const ok=document.getElementById("ok");
  ok.classList.add("show");
  setTimeout(()=>ok.classList.remove("show"),800);
}
function setStatus(msg){ document.getElementById("status").textContent = msg; }

function stopScan(){
  try{ reader?.reset?.(); }catch(e){}
  if(videoEl){
    try{ videoEl.srcObject && videoEl.srcObject.getTracks().forEach(t=>t.stop()); }catch(e){}
    try{ videoEl.remove(); }catch(e){}
  }
  videoEl=null;
  scanning=false;
}

async function scan(){
  if(scanning) return;
  stopScan();
  scanning=true;

  setStatus("Aponte para o cÃ³digo de barrasâ€¦");
  videoEl=document.createElement("video");
  videoEl.id="scanVideo";
  videoEl.setAttribute("playsinline","true");
  document.querySelector(".wrap").insertBefore(videoEl, document.getElementById("status"));

  const hints=new Map();
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.UPC_A
  ]);

  reader=new ZXing.BrowserMultiFormatReader(hints);

  try{
    // iPhone: nÃ£o escolher deviceId (mais estÃ¡vel)
    reader.decodeFromVideoDevice(null, videoEl, (result)=>{
      if(result){
        const code=result.getText().trim();
        stopScan();
        beep(); flashGreen();
        document.getElementById("gtin").value = code;
        setStatus("GTIN lido. Preencha nome e (se quiser) preÃ§o, depois clique em SALVAR.");
      }
    });
  }catch(e){
    stopScan();
    setStatus("NÃ£o consegui acessar a cÃ¢mera. Verifique permissÃµes do navegador.");
  }
}

async function salvar(){
  stopScan();

  const gtin = document.getElementById("gtin").value.trim();
  const nome = document.getElementById("nome").value.trim();
  const preco = document.getElementById("preco").value.trim();

  if(!gtin){ setStatus("Informe o GTIN."); return; }
  if(!nome){ setStatus("Informe o Nome dos Produtos."); return; }

  setStatus("Salvando no Notionâ€¦");

  const r = await fetch("/api/upsert", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ gtin, nome, preco })
  });

  const d = await r.json().catch(()=>({}));

  if(!r.ok || !d.ok){
    setStatus("Erro ao salvar. Se quiser, me mande print desta tela.");
    return;
  }

  setStatus(d.mode === "created" ? "âœ… Produto CRIADO no Notion!" : "âœ… Produto ATUALIZADO no Notion!");
}

function limpar(){
  stopScan();
  document.getElementById("gtin").value = "";
  document.getElementById("nome").value = "";
  document.getElementById("preco").value = "";
  setStatus("Aguardandoâ€¦");
}
</script>
</body>
</html>